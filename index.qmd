---
title: "Visualizing the impact of hurricanes on mangroves over time"
author: Isabel Liston
date: today
date-format: long
format: 
  html: 
    code-fold: true
  pdf:
    documentclass: scrartcl
    papersize: letter
---

# Introduction:

Mangrove trees are a very important aspect of many coastal ecosystems. Many of these areas are also impacted by hurricanes, therefore it is beneficial to understand how hurricanes damage mangrove trees and how long it takes trees to recover from said damage. Following Hurricane Andrew in 1992 permanent study plots were established, then more were added to examine historic areas of study. In total there are 23 plots with data spanning 1992-2011. The goal of this project is to visualize many different aspects of how individual mangroves, different mangrove species and the plots overall respond to hurricanes over time.

# Materials and Methods:

## Load libraries

```{r, warning = FALSE, message = FALSE}
library(readr)
library(tidyverse)
library(ggplot2)
library(drat)
addRepo("geanders")
update.packages("hurricaneexposure")
update.packages("hurricaneexposuredata")
library(hurricaneexposure)
library(hurricaneexposuredata)
library(sf)
library(spData)
library(leaflet)
library(foreach)
library(doParallel)
library(lubridate)
library(grid)
library(gtable)
library(gridExtra)
library(png)
```

## Load data

```{r, warning = FALSE, message = FALSE}
data("us_states")
data("hurr_tracks")
EVG_raw_data <- read.csv("data/Everglades_Mangrove_Vegetation_plot_data.csv")
```

## Clean up data

```{r, warning = FALSE, message = FALSE}
#create the study area bounding box
bbox_coords <- c(-81.2133, 25.5831,-80.9134, 25.1589)

#create a polygon from the bounding box
bbox_polygon <- st_as_sf(st_sfc(st_polygon(list(matrix(c(
   bbox_coords[1], bbox_coords[2],  
   bbox_coords[3], bbox_coords[2],
   bbox_coords[3], bbox_coords[4],  
   bbox_coords[1], bbox_coords[4],
   bbox_coords[1], bbox_coords[2]   
), ncol = 2, byrow = TRUE))), crs = 4269))

study_crs <- st_crs(bbox_polygon)

FL_state <- filter(us_states, NAME == "Florida")

study_area <- st_crop(us_states, bbox_polygon)

EVG_tidy <- EVG_raw_data %>%
              subset(dbh_cm != "NA") %>%
              group_by(plot_ID) %>%
              mutate(across(contains("date"), ~ mdy(.))) %>%
              arrange(., date)
              
EVG_tidy_spat <- EVG_tidy %>%
                  st_as_sf(coords = c("longitude", "latitude"), 
                           crs = study_crs)

EVG_plots <- EVG_tidy_spat %>%
              distinct(plot_ID, site, geometry)
```

# Results:

## Plot spatial distribution of study plots

```{r, warning = FALSE, message = FALSE}
plot_dist <- leaflet(EVG_tidy_spat)%>%
                addTiles()%>%
                fitBounds(., lng1 = -81.2133, lat1 = 25.5831,
                          lng2 = -80.9134, lat2 = 25.1589)%>%
                addMarkers(data = EVG_plots, popup = EVG_plots$site)
plot_dist    
```

## Plot hurricane tracks passing through the study area between 1992-2011

```{r, warning = FALSE, message = FALSE}
hurr_paths <- map_tracks(storms = c("Andrew-1992","Irene-1999",
                                    "Katrina-2005", "Wilma-2005"))

hurr_paths_spat <- hurr_paths[["layers"]][[2]][["data"]] %>%
                    st_as_sf(.,coords = c("longitude", "latitude"), 
                              crs = 4269) %>%
                    st_crop(.,FL_state)

study_area_hurr_paths <- st_crop(hurr_paths_spat, study_area)

state_view <- ggplot() +
                geom_sf(data = FL_state) +
                geom_sf(data = study_area, fill = "green")+
                geom_sf(data = hurr_paths_spat, aes(color = storm_id))
state_view

study_area_view <- ggplot()+
                    geom_sf(data = study_area)+
                    geom_sf(data = study_area_hurr_paths, aes(color = storm_id))+
                    geom_sf(data = EVG_plots, shape = 15)+
                    theme(axis.text.x = element_text(angle = 270, vjust = 0.5, 
                                                     hjust=1))

study_area_view
```

## Plot species make up of each plot over time:
```{r}
cl <- makeCluster(4)
registerDoParallel(cl)

sites <- factor(EVG_tidy$plot_ID)

results <- foreach(i = levels(sites), 
                   .packages = c("dplyr", "ggplot2")) %dopar% {

                  plot_makeup <- EVG_tidy %>% 
                                 filter(plot_ID == i) %>%
                                 group_by(plot_ID, date, scientific_name) %>%
                                 summarize(individual_count = n(), 
                                           .groups = "drop")
  
                  bar_chart <- ggplot(data = plot_makeup, 
                                      aes(fill = scientific_name, 
                                          y = individual_count, 
                                          x = date)) +
                               geom_bar(position = "fill", 
                                        stat = "identity") +
                               ggtitle(paste("Plot", i))
  
                   file_name <- paste("plot_", i, ".png", sep = "")
  
                   ggsave(filename = file_name, plot = bar_chart, 
                          width = 10, height = 8, units = "in")
  
                   return(file_name)}

stopCluster(cl)

grob_list <- lapply(results, function(file_name) {
  img <- readPNG(file_name)        
  raster_grob <- rasterGrob(img)   
  return(raster_grob)})

all_plots <- grid.arrange(grobs = grob_list, ncol = 4, nrow = 6)

ggsave(filename = "all_plots.png", plot = all_plots, 
       width = 20, height = 15, units = "in")
```
## Plot the change in a single plot over time:
### Find the most impacted plot/plots:
```{r, message = FALSE, warning = FALSE}
# Transform to a projected coordinate system (NAD83 / UTM Zone 17N)
EVG_plots_trans <- st_transform(EVG_plots, crs = 32617)  # NAD83 / UTM zone 17N (projected)
study_area_hurr_paths_trans<- st_transform(study_area_hurr_paths, crs = 32617)
study_area_trans <- st_transform(study_area, crs = 32617) 

# Create buffer for EVG_plots and hurr_paths (1 mile = 1609.34 meters)
EVG_plots_buffer <- st_buffer(EVG_plots_trans, dist = (1609.34*0.5))
study_area_hurr_paths_buffer <- st_buffer(study_area_hurr_paths_trans, 
                                          dist = (1609.34))

# Find the intersection of the buffers
overlap <- st_intersection(EVG_plots_buffer, study_area_hurr_paths_buffer)
overlap

#Visualize the intersection
ggplot()+
  geom_sf(data = study_area_trans)+
  geom_sf(data = study_area_hurr_paths_buffer, aes(color = storm_id), alpha = 0.25)+
  geom_sf(data = study_area_hurr_paths_trans, aes(color = storm_id))+
  geom_sf(data = EVG_plots_buffer, aes(fill = site))+
  geom_sf(data = overlap, aes(fill = site), color= "yellow")+
  theme(axis.text.x = element_text(angle = 270, vjust = 0.5, hjust=1))
```
## Plot the DBH of each tree over time to track growth/recovery
```{r}
plot_BRU <- EVG_tidy_spat %>%
              filter(plot_ID == "BRU") %>%
              subset(status != "dead") %>%
              group_by(date, scientific_name) %>%
              mutate("avg_species_dbh_cm" = mean(dbh_cm))

ggplot(plot_BRU) +
  geom_point(aes(x = date, y = avg_species_dbh_cm, color = scientific_name)) +
  geom_line(aes(x = date, y = avg_species_dbh_cm, color = scientific_name, 
                group = scientific_name)) +
  geom_vline(xintercept = as.Date("1999-10-15"), color = "gray", 
             linetype = "dashed", linewidth = 1) +
  annotate("text",x = as.Date("1999-10-15"), y = 0, 
            label = "Hurricane Irene", 
            color = "black")+
  theme_minimal()
```

```{r}
plot_BRM <- EVG_tidy_spat %>%
               filter(plot_ID == "BRM") %>%
               subset(status != "dead") %>%
               group_by(date, scientific_name) %>%
               mutate("avg_species_dbh_cm" = mean(dbh_cm))

ggplot(plot_BRM) +
  geom_point(aes(x = date, y = avg_species_dbh_cm, color = scientific_name)) +
  geom_line(aes(x = date, y = avg_species_dbh_cm, color = scientific_name, 
                group = scientific_name)) +
  geom_vline(xintercept = as.Date("1999-10-15"), color = "gray", 
             linetype = "dashed", linewidth = 1) +
  annotate("text",x = as.Date("1999-10-15"), y = 0, 
            label = "Hurricane Irene", 
            color = "black")+
  geom_vline(xintercept = as.Date("2005-08-26"), color = "gray", 
             linetype = "dashed", linewidth = 1) +
  annotate("text",x = as.Date("2005-08-26"), y = 0, 
            label = "Hurricane Katrina", 
            color = "black") +
  xlim(min(plot_BRM$date), max(plot_BRM$date) + 365) +
  theme_minimal()

```


# Conclusions:

\[\~200 words\]

Clear summary adequately describing the results and putting them in context. Discussion of further questions and ways to continue investigation.

# References:

Doyle, T. W., Smith, T. J., & Robblee, M. B. (1995). Wind Damage Effects of Hurricane Andrew on Mangrove Communities Along the Southwest Coast of Florida, USA. Journal of Coastal Research, 159–168.

Laura C Feher, Thomas J. Smith III, Gordon H Anderson, Ginger Tiling-Range, Karen M. Balentine, Greg A Ward, Kevin R. T. Whelan, Christa L. Walker, Andre Daniels, Michael J Osland, & Fara S. Ilami. (n.d.). Everglades mangrove vegetation data from 23 long-term plots (1992-2011). U.S. Geological Survey. https://doi.org/10.5066/P13DONMU

Smith III, T. J., Anderson, G., Balentine, K., Tiling, G., Ward, G., & Whelan, K. (2009). Cumulative Impacts of Hurricanes on Florida Mangrove Ecosystems: Sediment Deposition, Storm Surges and Vegetation. Wetlands, 29, 24–34. https://doi.org/10.1672/08-40.1
